<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QC Defect Submission</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 10px;
    max-width: 600px;
    margin: auto;
  }
  .form-group {
    display: flex;
    flex-direction: row;
    margin-bottom: 10px;
  }
  .form-group label {
    flex: 1;
    padding-right: 10px;
    font-weight: bold;
  }
  .form-group input, .form-group textarea {
    flex: 2;
    padding: 5px;
  }
  #preview {
    margin-top: 10px;
    max-width: 100%;
    border: 1px solid #ccc;
  }
  button {
    margin-top: 10px;
    padding: 10px;
    width: 100%;
    font-size: 16px;
  }
</style>
</head>
<body>

<h2>QC Defect Submission</h2>

<div class="form-group">
  <label for="salesOrder">Sales Order No.</label>
  <input type="text" id="salesOrder">
</div>
<div class="form-group">
  <label for="itemNo">Item No.</label>
  <input type="text" id="itemNo">
</div>
<div class="form-group">
  <label for="customerName">Customer Name</label>
  <input type="text" id="customerName">
</div>
<div class="form-group">
  <label for="itemName">Item Name</label>
  <input type="text" id="itemName">
</div>
<div class="form-group">
  <label for="defectDesc">Defect Description</label>
  <textarea id="defectDesc"></textarea>
</div>
<div class="form-group">
  <label for="defectCount">Defective Item Count</label>
  <input type="number" id="defectCount">
</div>

<button id="takePhotoBtn">Take Photo</button>
<img id="preview" src="" alt="Image Preview">

<button id="submitBtn">Submit</button>

<script>
let imageBlob = null;

// 压缩图片函数
function compressImage(file, maxWidth = 1024, quality = 0.7) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const ratio = Math.min(maxWidth / img.width, 1);
      canvas.width = img.width * ratio;
      canvas.height = img.height * ratio;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(blob => resolve(blob), 'image/jpeg', quality);
    };
    img.src = URL.createObjectURL(file);
  });
}

document.getElementById('takePhotoBtn').addEventListener('click', async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    const video = document.createElement('video');
    video.srcObject = stream;
    video.play();

    const canvas = document.createElement('canvas');

    const snap = async () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      canvas.toBlob(async blob => {
        imageBlob = await compressImage(blob, 1024, 0.7);
        document.getElementById('preview').src = URL.createObjectURL(imageBlob);
        stream.getTracks().forEach(track => track.stop());
      }, 'image/jpeg', 0.9);
    };

    video.addEventListener('loadedmetadata', () => {
      setTimeout(snap, 1000); // 1秒后拍照
    });
  } catch (err) {
    alert('Camera access denied or not available.');
  }
});

document.getElementById('submitBtn').addEventListener('click', async () => {
  const data = {
    salesOrder: document.getElementById('salesOrder').value.trim(),
    itemNo: document.getElementById('itemNo').value.trim(),
    customerName: document.getElementById('customerName').value.trim(),
    itemName: document.getElementById('itemName').value.trim(),
    defectDesc: document.getElementById('defectDesc').value.trim(),
    defectCount: document.getElementById('defectCount').value.trim()
  };

  if (!data.salesOrder || !data.itemNo || !imageBlob) {
    alert('Please fill required fields and take a photo.');
    return;
  }

  const formData = new FormData();
  formData.append('data', JSON.stringify(data));
  formData.append('image', imageBlob, `${data.salesOrder}-${data.itemNo}.jpg`);

  try {
    const resp = await fetch('https://script.google.com/macros/s/AKfycbxTFbzcaOS0_6tANdoch3Zmy0Mr40jmRuMxPOrX9nw_Wie0Y3O1ss_Ftohcmsf500Q/exec', {
      method: 'POST',
      body: formData
    });
    const result = await resp.text();
    alert(result);
  } catch (err) {
    alert('Submission failed: ' + err);
  }
});
</script>

</body>
</html>
